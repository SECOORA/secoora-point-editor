<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.16.4/lodash.min.js"></script>
    <script src="ext/localforage.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid.min.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid-theme.min.css" />
    <script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid.js"></script>

    <link rel="stylesheet" href="ext/bootstrap-flex.css" />

    <style>
body {
  font-family: sans-serif;
  display: flex;
  height: 100vh;
  width: 100vw;
  flex-direction: row;
  margin: 0px;
}

.center {
max-width: 100%;
  display: flex;
  flex: 1;
}

      .central {
        display: flex;
        flex-direction: column;
        flex: 1;
        max-width: 75%;
      }

      #mapid {
        flex: 1;
      }

      .editor {
        flex: 0 0 50px;
      }

      .layerbar {
        flex: 0 0 25%;
        order: -1;
      }

      .layerbar__predefined, .layerbar__user {
        padding-left: 10px;
      }

      .layercard {
        display: flex;
      }

      .layercard:hover {
        cursor: pointer;
      }

      .layercard--disabled {
        color: #ccc;
        background-color: white;
      }

      .layercard__swatch {
        border-radius: 6px;
        border: 1px solid #555;

        width: 1em;
        height: 1em;
        margin-right: 0.3em;
      }

      .layercard__text {
        flex: 1;
      }

.editor table {
    /*word-break: break-all;*/
}
.editor table td, .editor table th {
    overflow: hidden;
}

.editor__toolbar {
  padding: 3px 0px;
  display: flex;
  justify-content: flex-end;
  flex-direction: row;
}

.editor__toolbar button {
  margin: 0px 3px;
}

    </style>
  </head>

  <body>
    <div class="central">
      <div id="mapid"></div>
      <div class="editor">
        <div class="editor__toolbar">
          <button type="button" class="btn btn-danger editor__toolbar__delete" disabled>Delete</button>
          <button type="button" class="btn btn-success editor__toolbar__export" disabled>Export</button>
          <button type="button" class="close"><span>&times;</span></button>
        </div>
        <div class="editor__grid">
        </div>
      </div>
    </div>

    <div class="layerbar">
      <div class="layerbar__predefined">
        <h3>SECOORA layers</h3>
        <ul class="list-group">
        </ul>
      </div>
      <div class="layerbar__user">
        <h3>User Layers</h3>
        <div class="layerbar__user__layers list-group">

        </div>
        <button type="button" class="btn btn-primary layerbar__user__add">New Layer</button>
      </div>
    </div>
  </div>
    <div class="modal fade" id="export-modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
            <h4 class="modal-title">Export</h4>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <textarea class="form-control export-modal__code" rows="20"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <a class="btn btn-primary export-modal__link" href="#">Download</a>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="new-modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
            <h4 class="modal-title">New Layer</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="new-modal__name">Name</label>
              <input type="text" class="form-control" id="new-modal__name" placeholder="Layer Name" />
              <label for="new-modal__geojson">GeoJSON</label>
              <textarea class="form-control" id="new-modal__geojson" rows="20">
{
  "type": "FeatureCollection",
  "features": []
} </textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary new-modal__import">Import</button>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">

      // storage engine
      localforage.config({
          driver: localforage.LOCALSTORAGE,
          name: 'secooraPointEntry',
          storeName: 'secoora_point_entry'
      });

      // @TODO: default layers get loaded/stored in localforage if no key already in localforage

      var colorScale = d3.scaleOrdinal(d3.schemeCategory20);

      // default layers
      var defaultLayers = [
        {name: 'bathygeon', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/bathy/bathy.geojson", visible: true},
        {name: 'hfradar', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/hfradar/hfradar.geojson", visible: true},
        {name: 'gliders_from_georefd', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/glider_tracks/gliders_from_georefd.geojson", visible: true},
        {name: 'georef_glider_triangles', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/glider_tracks/georef_glider_triangles.geojson", visible: true},
        {name: 'gliders', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/gliders/gliders.geojson", visible: true},
        {name: 'stations', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/stations/stations.geojson", visible: true}
      ]

      // leaflet
      var map = L.map('mapid').setView([30.676, -80.134], 6);
      var layer = new L.StamenTileLayer("terrain-background");
      //var attribution = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
      //var layer = L.tileLayer('http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png', {attribution: attribution})
      map.addLayer(layer);

      // add default layers
      var q = d3.queue();
      defaultLayers.forEach(function(e) {
        q.defer(d3.json, e.url);
      });

      q.awaitAll(function(error, data) {
        //console.log(data);

        // zip back up with original data
        var newData = _.map(defaultLayers, function(d, i) {
          return _.assign(_.clone(d), {
            color: colorScale(i),
            layer: L.geoJson(data[i], {
              pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                  radius: 5,
                  fillColor: colorScale(i),
                  color: colorScale(i),
                  weight: 1,
                  opacity: 1,
                  fillOpacity: 1
                });
              },
              style: {
                color: colorScale(i),
                weight: 2
              }              
          })});
        });

        newData.forEach(function(e) {
          e.layer.addTo(map);
        });

        // add to left hand controls
        var cards = d3.select('.layerbar__predefined .list-group')
          .selectAll('li')
          .data(newData)
          .enter()
          .append('li')
          .attr('class', 'list-group-item')
          .on('click', function(d) {
            d3.select(this).classed('disabled', d.visible);

            if (d.visible) {
              map.removeLayer(d.layer);
              d.visible = false;
            } else {
              map.addLayer(d.layer);
              d.visible = true;
            }
          });

        cards.append('div')
          .attr('class', 'tag tag-default tag-pill float-xs-right')
          .style('background-color', function(d) { return d.color })
          .html("&nbsp;");

        cards.append('div')
          .attr('class', 'layercard__text')
          .text(function(d) { return d.name });
      });

      function dataToGeoJson(data) {
          var features = _.map(data, function(d) {
            var props = _.omit(d, ['lon', 'lat']);
            return {
                type: "Feature",
                properties: props,
                geometry: {
                    type: "Point",
                    coordinates: [
                        d.lon,
                        d.lat
                    ]
                }
            }
          });
          return {
              type: "FeatureCollection",
              features: features
          }
      }

      function save(dataItem) {
        // set in userLayers
        if (dataItem.index === undefined) {
          dataItem.index = window.userLayers.length;
        }
        window.userLayers[dataItem.index] = dataItem;
        return _save();
      }

      /**
        * Saves whatever is currently in userLayers
        */
      function _save() {
        // strip presentation attributes from userLayers
        var saveValue = _.map(window.userLayers, function(d) {
          return _.omit(d, ['layer', 'color', 'index']);
        });

        // store in localstorage
        return localforage.setItem('user-layers', saveValue);
      }

      function loadUserLayers(value) {
        window.userLayers = _.map(value, function(d, i) {
          var gj = dataToGeoJson(d.data),
            color = colorScale(defaultLayers.length + i);

          // always assign color/visible/index, index will change!
          _.assign(d, {
              color: color,
              visible: d.visible !== false,
              index: i,
          });

          // only create/assign layer if we don't already have one
          if (d.layer === undefined) {
              d.layer = L.geoJson(gj, {
                  pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                      radius: 5,
                      fillColor: color,
                      color: color,
                      weight: 1,
                      opacity: 1,
                      fillOpacity: 1
                    });
                  },
                  style: {
                      color: color
                  }});
          }

          return d;
        });

        // add to left hand controls
        var selCards = d3.select('.layerbar__user__layers')
          .selectAll('li')
          .data(window.userLayers, function(d) {
               return d.name;
          });

        // delete if necessary
        selCards.exit()
          .remove();

        // remove map layers on anything in exit selection
        // @TODO: peeks too much into internals
        selCards.exit()._groups[0].forEach(function(e) {
            map.removeLayer(e.__data__.layer);
        });

        var cards = selCards.enter()
          .append('li')
          .attr('class', 'list-group-item')
          .on('click', function(d) {
            d3.select(this).classed('disabled', d.visible);

            if (d.visible) {
              map.removeLayer(d.layer);
              d.visible = false;
            } else {
              map.addLayer(d.layer);
              d.visible = true;
            }
          });

        // add map layers on anything in enter selection
        // @TODO: peeks too much into internals
        cards._groups[0].forEach(function(e) {
            e.__data__.layer.addTo(map);
        });

        cards.append('div')
          .attr('class', 'tag tag-default tag-pill float-xs-right')
          .style('background-color', function(d) { return d.color })
          .html('&nbsp;');

        cards.append('div')
          .attr('class', 'layercard__text')
          .text(function(d) { return d.name });

        cards.append('a')
            .attr('class', 'layercard__edit')
            .text("edit")
            .on('click', function(d) { 
                event.stopPropagation();

                // enable buttons
                $('.editor__toolbar button').attr('disabled', false);

                // add handler for export
                $('.editor__toolbar__export').off('click');
                $('.editor__toolbar__export').click(function() {
                  var gj = dataToGeoJson(d.data),
                    gjs = JSON.stringify(gj, null, '  ');

                  $('.export-modal__code').val(gjs);
                  $('.export-modal__link').attr('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(gjs));
                  $('.export-modal__link').attr('download', d.name + ".geojson");
                  $('#export-modal').modal();
                });

                // sizeup editor pane
                $('.editor').css('flex-basis', '40%');

                // add handler for delete
                $('.editor__toolbar__delete').off('click');
                $('.editor__toolbar__delete').click(function() {
                  if (window.confirm("Do you really want to delete layer " + d.name + "?")) {
                    // remove from userLayers, store in localforage
                    window.userLayers.splice(d.index, 1);
                    _save();    // we're not updating or adding so just use internal save current

                    // run through updateLayers
                    loadUserLayers(window.userLayers);

                    // close editor
                    closeEditorPane();
                  }
                });

                // define data controller for editor view
                // interfaces with localforage
                var controller = {
                  loadData: function(filter) {
                    console.log("LOADING", d.data);
                    return _.map(d.data, function(dd, ii) {
                      return _.assign({_idx: ii}, dd);
                    });
                  },
                  insertItem: function(item) {
                    console.log("INSERT", item);
                    
                    // append new item to d
                    var newIdx = d.data.length;
                    d.data[newIdx] = _.clone(item);

                    // store in localstorage
                    return save(d).then(function() {
                      item._idx = newIdx;
                      return item;
                    });
                  },
                  updateItem: function(item) {
                    console.log("UPDATE", item);

                    var idx = item._idx,
                      newItem = _.omit(item, ['_idx']);

                    d.data[idx] = newItem;

                    // store in localstorage
                    return save(d).then(function() {
                      return item;
                    });
                  },
                  deleteItem: function(item) {
                    console.log("DELETE", item);

                    var idx = item._idx;
                    d.data.splice(idx, 1);

                    // store in localstorage
                    return save(d);
                  }
                };

                // extend jsgrid with decimal type
                var DecimalField = function(config) {
                  jsGrid.Field.call(this, config);
                };

                DecimalField.prototype = new jsGrid.NumberField({
                  filterValue: function() { 
                    return parseFloat(this.filterControl.val());
                  },
                  insertValue: function() {
                    return parseFloat(this.insertControl.val());
                  },
                  editValue: function() {
                    return parseFloat(this.editControl.val());
                  }
                });

                jsGrid.fields.decimal = DecimalField;

                // default schema
                var defaultSchema = [
                  { name: "name", type: "text" },
                  { name: "lat", type: "decimal" },
                  { name: "lon", type: "decimal" },
                ]

                // grab any additional fields
                var schema = defaultSchema.concat(_.map(_.filter(_.uniq(_.flatten(_.map(d.data, function(dd) {
                  return _.keys(dd);
                }))), function(dd) {
                  return _.map(defaultSchema, 'name').indexOf(dd) == -1;
                }), function(dd) {
                  return {
                    name: dd,
                    type: "text"
                  }
                }));

                schema.push({type: "control"});

                $('.editor__grid').jsGrid({
                  width: "100%",

                  inserting: true,
                  editing: true,
                  sorting: false,
                  paging: false,

                  autoload: true,
                  fields: schema,
                  controller: controller,

                  onItemInserted: function(args) {
                    // new layer for new item
                    var item = args.item,
                      lat = parseFloat(item.lat) || 0,
                      lon = parseFloat(item.lon) || 0,
                      latlng = new L.LatLng(lat, lon),
                      marker = L.circleMarker(latlng, {
                        radius: 5,
                        fillColor: d.color,
                        color: d.color,
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 1
                      });

                    marker.bindPopup(item.name);
                    d.layer.addLayer(marker);
                  },

                  onItemUpdated: function(args) {
                    // adjust marker
                    var item = args.item,
                      lat = parseFloat(item.lat) || 0,
                      lon = parseFloat(item.lon) || 0,
                      latlng = new L.LatLng(lat, lon),
                      marker = d.layer.getLayers()[item._idx];

                    marker.setLatLng(latlng);
                    marker.bindPopup(item.name);
                  },

                  onItemDeleted: function(args) {
                    // remove marker!
                    var item = args.item,
                      marker = d.layer.getLayers()[item._idx];
                    d.layer.removeLayer(marker);
                  }
                });
            });

      }

      // LOAD USER DEFINED LAYERS FROM LOCALSTORAGE
      localforage.getItem('user-layers')
        .then(function(value) {
          if (value === null) {
            value = [];
          }
          window.userLayers = value;
          return window.userLayers;
        })
        .then(loadUserLayers)
        .catch(function(err) {
          console.error(err)
      });

      $('.layerbar__user__add').click(function() {
        $('#new-modal').modal();
      });

      $('.new-modal__import').click(function() {

        // transform geojson into our format
        var gj = $('#new-modal__geojson').val(),
          gjo = JSON.parse(gj),
          name = $('#new-modal__name').val() || "Unnamed Layer",
          layer = {
            name: name,
            visible: true,
            data: _.map(gjo.features, function(d, i) {
              return _.assign({
                name: d.properties.name || "Item " + (i+1),
                lat: d.geometry.coordinates[1],
                lon: d.geometry.coordinates[0]
              }, d.properties);
            })
          };

        // save to localforage
        save(layer).then(function() {
          // reupdate UI
          loadUserLayers(window.userLayers);
        });

        $('#new-modal').modal('hide');
      });

      function closeEditorPane() {
        // shrink editor pane
        $('.editor').css('flex-basis', '50px');

        // disable toolbar buttons, remove handlers
        $('.editor__toolbar__export').attr('disabled', true);
        $('.editor__toolbar__delete').attr('disabled', true);
        $('.editor__toolbar__export').off('click');
        $('.editor__toolbar__delete').off('click');

        // remove jsGrid
        $('.editor__grid').jsGrid("destroy");
      }

      $('.editor .close').click(closeEditorPane);

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="ext/bootstrap.min.js"></script>
  </body>
</html>


