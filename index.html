<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.16.4/lodash.min.js"></script>
    <script src="ext/localforage.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid.min.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid-theme.min.css" />
    <script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid.js"></script>

    <style>
body {
  font-family: sans-serif;
  display: flex;
  min-height: 100vh;
  flex-direction: row;
  margin: 0px;
}

.center {
  display: flex;
  flex: 1;
}

      .central {
          display: flex;
          flex-direction: column;
        flex: 1;
      }

      #mapid {
        flex: 1;
      }

      .editor {
        flex: 0 0 25%;
      }

      .layerbar {
        flex: 0 0 25%;
        order: -1;
      }

      .layerbar__predefined, .layerbar__user {
        padding-left: 10px;
      }

      .layercard {
        margin: 5px;
        background-color: #f6f6f6;
        border: 1px solid #ccc;
        border-radius: 2px;
        padding: 10px;

        display: flex;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 3px 1px -2px rgba(0, 0, 0, 0.2), 0 1px 5px 0 rgba(0, 0, 0, 0.12)
      }

      .layercard:hover {
        cursor: pointer;
      }

      .layercard--disabled {
        color: #ccc;
        background-color: white;
      }

      .layercard__swatch {
        border-radius: 6px;
        border: 1px solid #555;

        width: 1em;
        height: 1em;
        margin-right: 0.3em;
      }

      .layercard__text {
        flex: 1;
      }

    </style>
  </head>

  <body>
    <div class="central">
        <div id="mapid"></div>
        <div class="editor">
          <div class="editor__grid">
          </div>
        </div>
    </div>
    <div class="layerbar">
      <div class="layerbar__predefined">
        <h3>SECOORA layers</h3>
      </div>
      <div class="layerbar__user">
        <h3>User Layers</h3>
        <div class="layerbar__user__layers">

        </div>
      </div>
    </div>
    <script type="text/javascript">

      // storage engine
      localforage.config({
          driver: localforage.LOCALSTORAGE,
          name: 'secooraPointEntry',
          storeName: 'secoora_point_entry'
      });

      // @TODO: default layers get loaded/stored in localforage if no key already in localforage

      var colorScale = d3.scaleOrdinal(d3.schemeCategory20);

      // default layers
      var defaultLayers = [
        {name: 'bathygeon', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/bathy/bathy.geojson", visible: true},
        {name: 'hfradar', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/hfradar/hfradar.geojson", visible: true},
        {name: 'gliders_from_georefd', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/glider_tracks/gliders_from_georefd.geojson", visible: true},
        {name: 'georef_glider_triangles', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/glider_tracks/georef_glider_triangles.geojson", visible: true},
        {name: 'gliders', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/gliders/gliders.geojson", visible: true},
        {name: 'stations', url: "https://raw.githubusercontent.com/SECOORA/static_assets/master/stations/stations.geojson", visible: true}
      ]

      // leaflet
      var map = L.map('mapid').setView([30.676, -80.134], 6);
      var layer = new L.StamenTileLayer("terrain-background");
      //var attribution = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
      //var layer = L.tileLayer('http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png', {attribution: attribution})
      map.addLayer(layer);

      // add default layers
      var q = d3.queue();
      defaultLayers.forEach(function(e) {
        q.defer(d3.json, e.url);
      });

      q.awaitAll(function(error, data) {
        //console.log(data);

        // zip back up with original data
        var newData = _.map(defaultLayers, function(d, i) {
          return _.assign(_.clone(d), {
            color: colorScale(i),
            layer: L.geoJson(data[i], {
              pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                  radius: 5,
                  fillColor: colorScale(i),
                  color: colorScale(i),
                  weight: 1,
                  opacity: 1,
                  fillOpacity: 1
                });
              },
              style: {
                color: colorScale(i),
                weight: 2
              }              
          })});
        });

        newData.forEach(function(e) {
          e.layer.addTo(map);
        });

        // add to left hand controls
        var cards = d3.select('.layerbar__predefined')
          .selectAll('.layercard')
          .data(newData)
          .enter()
          .append('div')
          .attr('class', 'layercard')
          .on('click', function(d) {
            d3.select(this).classed('layercard--disabled', d.visible);

            if (d.visible) {
              map.removeLayer(d.layer);
              d.visible = false;
            } else {
              map.addLayer(d.layer);
              d.visible = true;
            }
          });

        cards.append('div')
          .attr('class', 'layercard__text')
          .text(function(d) { return d.name });

        cards.append('div')
          .attr('class', 'layercard__swatch')
          .style('background-color', function(d) { return d.color });
      });

      function dataToGeoJson(data) {
          var features = _.map(data, function(d) {
            var props = _.omit(d, ['lon', 'lat']);
            return {
                type: "Feature",
                properties: props,
                geometry: {
                    type: "Point",
                    coordinates: [
                        d.lon,
                        d.lat
                    ]
                }
            }
          });
          return {
              type: "FeatureCollection",
              features: features
          }
      }

      // USER DEFINED LAYERS
      localforage.getItem('user-layers').then(function(value) {

        var parsedData = _.map(value, function(d, i) {
          var gj = dataToGeoJson(d.data),
            color = colorScale(defaultLayers.length + i);

          return _.assign(d, {
              layer: L.geoJson(gj, {
                  pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                      radius: 5,
                      fillColor: color,
                      color: color,
                      weight: 1,
                      opacity: 1,
                      fillOpacity: 1
                    });
                  },
                  style: {
                      color: color
                  }}),
              color: color,
              visible: d.visible !== false,
              index: i,
          });
        });

        console.log(parsedData);

        parsedData.forEach(function(e) {
            e.layer.addTo(map);
        });

        function save(dataItem) {
          // strip presentation attributes from dataItem
          var newD = _.omit(dataItem, ['layer', 'color', 'index']);

          // set in value
          value[dataItem.index] = newD;

          // store in localstorage
          return localforage.setItem('user-layers', value);
        }

        // add to left hand controls
        var cards = d3.select('.layerbar__user__layers')
          .selectAll('.layercard')
          .data(parsedData)
          .enter()
          .append('div')
          .attr('class', 'layercard')
          .on('click', function(d) {
            d3.select(this).classed('layercard--disabled', d.visible);

            if (d.visible) {
              map.removeLayer(d.layer);
              d.visible = false;
            } else {
              map.addLayer(d.layer);
              d.visible = true;
            }
          });

        cards.append('div')
          .attr('class', 'layercard__text')
          .text(function(d) { return d.name });

        cards.append('div')
          .attr('class', 'layercard__swatch')
          .style('background-color', function(d) { return d.color });

        cards.append('a')
            .attr('class', 'layercard__edit')
            .text("edit")
            .on('click', function(d) { 
                event.stopPropagation();

                // define data controller for editor view
                // interfaces with localforage
                var controller = {
                  loadData: function(filter) {
                    console.log("LOADING", d.data);
                    return _.map(d.data, function(dd, ii) {
                      return _.assign({_idx: ii}, dd);
                    });
                  },
                  insertItem: function(item) {
                    console.log("INSERT", item);
                    
                    // append new item to d
                    var newIdx = d.data.length;
                    d.data[newIdx] = _.clone(item);

                    // store in localstorage
                    return save(d).then(function() {
                      item._idx = newIdx;
                      return item;
                    });
                  },
                  updateItem: function(item) {
                    console.log("UPDATE", item);

                    var idx = item._idx,
                      newItem = _.omit(item, ['_idx']);

                    d.data[idx] = newItem;

                    // store in localstorage
                    return save(d).then(function() {
                      return item;
                    });
                  },
                  deleteItem: function(item) {
                    console.log("DELETE", item);

                    var idx = item._idx;
                    d.data.splice(idx, 1);

                    // store in localstorage
                    return save(d);
                  }
                };

                // default schema
                var defaultSchema = [
                  { name: "name", type: "text" },
                  { name: "lat", type: "number" },
                  { name: "lon", type: "number" },
                ]

                // grab any additional fields
                var schema = defaultSchema.concat(_.map(_.filter(_.uniq(_.flatten(_.map(d.data, function(dd) {
                  return _.keys(dd);
                }))), function(dd) {
                  return _.map(defaultSchema, 'name').indexOf(dd) == -1;
                }), function(dd) {
                  return {
                    name: dd,
                    type: "text"
                  }
                }));

                schema.push({type: "control"});

                $('.editor__grid').jsGrid({
                  width: "100%",
                  height: "400px",

                  inserting: true,
                  editing: true,
                  sorting: false,
                  paging: false,

                  autoload: true,
                  fields: schema,
                  controller: controller,

                  onItemInserted: function(args) {
                    // new layer for new item
                    var item = args.item,
                      lat = parseFloat(item.lat) || 0,
                      lon = parseFloat(item.lon) || 0,
                      latlng = new L.LatLng(lat, lon),
                      marker = L.circleMarker(latlng, {
                        radius: 5,
                        fillColor: d.color,
                        color: d.color,
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 1
                      });

                    marker.bindPopup(item.name);
                    d.layer.addLayer(marker);
                  },

                  onItemUpdated: function(args) {
                    // adjust marker
                    var item = args.item,
                      lat = parseFloat(item.lat) || 0,
                      lon = parseFloat(item.lon) || 0,
                      latlng = new L.LatLng(lat, lon),
                      marker = d.layer.getLayers()[item._idx];

                    marker.setLatLng(latlng);
                    marker.bindPopup(item.name);
                  },

                  onItemDeleted: function(args) {
                    // remove marker!
                    var item = args.item,
                      marker = d.layer.getLayers()[item._idx];
                    d.layer.removeLayer(marker);
                  }
                });
            });

      }).catch(function(err) {
          console.error(err)
      });

    </script>
  </body>
</html>
